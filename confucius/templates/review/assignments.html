{% extends 'base-in.html' %}
{% load url from future %}

{% block title %}Assignments {% endblock %}
{% block brand %}Conference "{{ conference.title }}"  
{% endblock %}
{% block content_header %}
<h1>Assignments</h1><br/>
{% endblock %}
{% block subtopbar %}
<div class="span12 db-top">
    <div class="db-top-inner-min">
        <i class="icon-calendar icon-white"></i> Start date {{ conference.start_date|date:'SHORT_DATE_FORMAT' }} | 
        <i class="icon-info-sign icon-white"></i> Submissions end date {{ conference.submissions_end_date|date:'SHORT_DATE_FORMAT' }} | 
        <i class="icon-exclamation-sign icon-white"></i> Reviews end date {{ conference.reviews_end_date|date:'SHORT_DATE_FORMAT' }}
    </div>
</div>
{% endblock %}
{% block content_main %}

{% include 'includes/assignments.html' %}

{% endblock %}
{% block extra_style %}
<style>
    tr.infos:hover {
        cursor:pointer;
    }
</style>
{% endblock %}
{% block script %}
<script src="{{ STATIC_URL }}jquery.selectoptionsort.js"></script>
<script src="{{ STATIC_URL }}jquery.ajaxsend.js"></script>
<script>

function updateReviewerList() {
    $('tr.infos').click(function(e) {
        $('tr.infos').next().hide();
        var paperid = $(this).attr("id")
        $(this).next().slideToggle('fast');
        $.post("{% url 'updateReviewerList' conference.pk %}", { 
            paper_id: paperid,
        },
            function(data) {
                $("#reviewers_list_"+paperid).find('option').remove();
                $.each(data,function(index, value) {
                    $("#reviewers_list_"+paperid).append("<option id=\""+value[0]+"\">"+value[1]+"</option>")
                });
            }
        );
        
        $.post("{% url 'refreshAssignationNumber' conference.pk %}", { 
            paper_id: paperid,
        },
            function(data) {
                $.each(data,function(index,value){
                    $("td#paper_count_"+value[0]).text(value[1]);
                });
            }
        );
        return false;
    }).next().hide();

}

function deleteAssignmentRow() {
    $('a.assignment').live("click",function(e) {
        var my_button = $(this)
        var assign_id = $(this).attr("id");
        var substri = assign_id.split('--table_');
        var paperid = parseInt(substri[1]);
        var start = substri[0];
        var toRemove = 'remove_';
        var end = start.replace(toRemove,'');

        
        $.post("{% url 'deleteAssignmentRow' conference.pk %}", {
                'end': end,
            },
            function(data) {
                my_button.parent().parent().remove();
                $.post("{% url 'updateReviewerList' conference.pk %}", { 
                    paper_id: paperid,
                },
                    function(data) {
                        $("#reviewers_list_"+paperid).find('option').remove();
                        $.each(data,function(index, value) {
                            $("#reviewers_list_"+paperid).append("<option id=\""+value[0]+"\">"+value[1]+"</option>")
                        });
                    }
                );
                var res = parseInt($("td#assignments_"+paperid).text());
                $("td#assignments_"+paperid).text(res-1);                    
            }
        );
    });
}

function updateAssignmentsTables() {
	$("select.selectAdd").click(function(){
	    var val = $(this).attr("id");
	    var clicked = $(".multiSelect option:selected");
        var toRemove = 'reviewers_list_';
        var end = val.replace(toRemove,'');
	    var table = $(document).find("table#table_"+end);
		if (val!=null){

            $.post("{% url 'updateAssignmentsTables' conference.pk %}", { 
                paper_id : end,
                reviewer_id : $(".multiSelect option:selected").attr("id")
            },
                function(data) {
                    $.each(data,function(index, value) {
                        table.append("<tr><td>"+value[2]+"</td><td>"+value[3]+"</td><td>"+value[5]+"</td><td id=\"paper_count_"+value[0]+"\">"+value[4]+"</td><td><a href=\"#\" class=\"btn btn-danger assignment\" id=\"remove_"+value[0]+"--table_"+end+"\">Remove</a></td></tr>");
                    });
                    var res = parseInt($("td#assignments_"+end).text());
                    $("td#assignments_"+end).text(res+1);
                    clicked.remove();
                }
            );
			
		}
	});
}


function auto_assign() {
	$('#auto_assignment').click(function(){
	    var by_paper = $("#avg_assi_by_paper").val();
	    if( by_paper == '' ) {
	        by_paper = 0;
	    }
	    var by_reviewer = $("#avg_assi_by_reviewer").val();
	    if( by_reviewer == '' ) {
	        by_reviewer = 0;
	    }
        $('#toggle_modal_loading').modal({
            keyboard: false
        }).show();
        $.post("{% url 'auto_assignment' conference.pk %}", {
                'by_paper':by_paper,
                'by_reviewer':by_reviewer,
            },
            function(data) {
                $('#messages').toggleClass('hide');
                $('#toggle_modal_loading').modal('hide');
                
                $.get("{% url 'assignments' conference.pk %}", {},
                function(data) {
                    var html = $('div#container', data).html();
                    $('div#container').replaceWith(html);
                    $('tr.infos').next().hide();
                    updateReviewerList();
                    
                    deleteAssignmentRow();
                    
                    updateAssignmentsTables();
                    
                    auto_assign();
                }
            );
            }
        );

        return false;
	});
}

    
    $(function() {
        // Displays all the reviewers not yet assigned to this paper for this conference in the select input
        updateReviewerList();
        
        // When a click on the "Remove" button is captured, we remove the reviewer from the table and add an option in the select input
        deleteAssignmentRow();
        
        // When a click is captured on the auto-assign button, lauch the modal frame and execute the algorithm
        updateAssignmentsTables();
        
        // When a click on a select option is captured, remove the option form the list, and add the reviewer to the table
        auto_assign();
    });
    
    
	$(function() {
		$("select.selectAdd").selectOptionSort();
	}); 

    



</script>
{% endblock %}
